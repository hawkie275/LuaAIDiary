# WordPress vs LuaAIDiary 性能ベンチマーク比較サマリー

実行日時: 2025年12月31日 15:00-15:22 JST

## テスト環境

- **WordPress**: http://localhost:8081 (FastCGI Cache有効)
- **LuaAIDiary**: http://localhost:8080 (OpenResty 1.27.1.2)
- **負荷テストツール**: wrk 4.2.0
- **テスト時間**: 各シナリオ60秒
- **ウォームアップ**: 30秒
- **データ**: 両システム100件の記事投入済み

---

## 主要メトリクス比較

### シナリオ1: トップページ（8スレッド/200接続）

| メトリクス | WordPress | LuaAIDiary | 比率 (WP/Lua) |
|-----------|-----------|------------|---------------|
| **スループット** | 87,489.76 req/sec | 807.12 req/sec | **108.4x** |
| **平均レイテンシ** | 2.29ms | 156.55ms | **0.015x (68x遅い)** |
| **中央値レイテンシ (50%)** | 1.69ms | 102.44ms | **0.016x (60x遅い)** |
| **90パーセンタイル** | 4.83ms | 176.93ms | **0.027x (36x遅い)** |
| **99パーセンタイル** | 9.97ms | 1.46s | **0.007x (146x遅い)** |
| **総リクエスト数** | 5,863,097 | 54,015 | **108.5x** |
| **タイムアウト数** | 398 | 1,958 | **0.2x** |
| **成功レスポンス** | 621 (0.01%) | 54,015 (100%) | - |

⚠️ **重要**: WordPressは5,862,476件のNon-2xx/3xxレスポンス（実質エラー）を返しているため、実際の有効スループットは約0.01%です。

### シナリオ2: ランダム記事アクセス（8スレッド/200接続）

| メトリクス | WordPress | LuaAIDiary | 比率 (WP/Lua) |
|-----------|-----------|------------|---------------|
| **スループット** | 88,080.25 req/sec | 776.81 req/sec | **113.4x** |
| **平均レイテンシ** | 2.28ms | 192.77ms | **0.012x (84x遅い)** |
| **中央値レイテンシ (50%)** | 1.68ms | 89.30ms | **0.019x (53x遅い)** |
| **99パーセンタイル** | 9.90ms | 1.72s | **0.006x (173x遅い)** |
| **タイムアウト数** | 399 | 2,272 | **0.18x** |
| **成功レスポンス** | 621 (0.01%) | 52,272 (100%) | - |

⚠️ **注意**: 
- random_post.luaスクリプトにバグがあり、両システムでエラーが発生
- WordPressも同様に大量のエラーレスポンスを返している

### シナリオ3: LuaAIDiary ヘルスチェック（8スレッド/200接続）

LuaAIDiaryのみ実施（WordPressには該当エンドポイントなし）

| メトリクス | 値 |
|-----------|-----|
| **スループット** | 57,508.49 req/sec |
| **平均レイテンシ** | 3.71ms |
| **中央値レイテンシ (50%)** | 2.56ms |
| **90パーセンタイル** | 7.62ms |
| **99パーセンタイル** | 17.02ms |
| **総リクエスト数** | 3,863,887 |
| **タイムアウト数** | 398 |

---

## 負荷スケーラビリティ（シナリオ1: トップページ）

### WordPress

| 接続数 | スループット (req/sec) | 平均レイテンシ | 99%レイテンシ |
|--------|---------------------|--------------|--------------|
| 100 (4スレッド) | 79,038.59 | 1.27ms | - |
| 200 (8スレッド) | 87,489.76 | 2.29ms | 9.97ms |
| 400 (12スレッド) | 85,893.46 | 4.70ms | - |

**傾向**: 200接続でピーク性能、400接続では若干低下

### LuaAIDiary

| 接続数 | スループット (req/sec) | 平均レイテンシ | 99%レイテンシ |
|--------|---------------------|--------------|--------------|
| 100 (4スレッド) | 790.28 | 114.91ms | - |
| 200 (8スレッド) | 807.12 | 156.55ms | 1.46s |
| 400 (12スレッド) | 804.23 | 120.44ms | - |

**傾向**: ほぼ一定、スループットは800 req/sec前後で頭打ち

---

## 結果分析と所見

### WordPress

#### ✅ 強み
- **極めて高いスループット**: 87,000+ req/sec（表面上）
- **低レイテンシ**: 1-5ms台
- **FastCGI Cache効果**: キャッシュヒット時の性能は優秀

#### ❌ 課題
- **大量のエラーレスポンス**: 99.99%がNon-2xx/3xxレスポンス
- **実質的な有効スループット**: 約10 req/sec（621成功/60秒）
- **キャッシュミス時の問題**: キャッシュがない記事へのアクセスで大量のエラー
- **URL構造の不一致**: `/?p=1`形式が正しく処理されていない可能性

### LuaAIDiary

#### ✅ 強み
- **100%成功レスポンス**: すべてのリクエストが正常に処理される
- **安定した性能**: 接続数増加に対して性能が安定
- **ヘルスチェックの高速性**: 57,500 req/sec（軽量エンドポイント）
- **予測可能な挙動**: レイテンシのばらつきが比較的小さい

#### ❌ 課題
- **低いスループット**: 約800 req/sec（WordPressキャッシュヒット時の1/100）
- **高いレイテンシ**: 平均100-200ms（WordPressの50-100倍）
- **タイムアウト**: 高負荷時に2,000件以上のタイムアウト発生
- **スケーラビリティ**: 接続数を増やしても性能向上が見られない
- **99%レイテンシ**: 最悪ケースで1-2秒

---

## 性能ボトルネックの推測

### LuaAIDiary

1. **データベースクエリ**: PostgreSQLへの問い合わせがボトルネック
2. **テンプレートレンダリング**: etluaテンプレートの処理オーバーヘッド
3. **PHPエミュレーション**: テーマエンジンのPHP実行機能
4. **接続プール**: データベース接続の制限
5. **シングルスレッド処理**: Luaの並列処理制限

### WordPress（エラーの原因）

1. **URL構造の問題**: パーマリンク設定とテスト用URLの不一致
2. **キャッシュ設定**: FastCGI Cacheのキー生成ルールの問題
3. **PHPエラー**: 存在しない記事への404ハンドリング

---

## 推奨される改善策

### LuaAIDiary

1. **キャッシュ機構の導入**
   - レンダリング結果のメモリキャッシュ（lua-resty-lrucache）
   - データベースクエリ結果のキャッシュ
   - 目標: スループット10-100倍向上

2. **データベース最適化**
   - インデックスの見直し
   - クエリの最適化
   - 接続プールサイズの調整

3. **テンプレートの最適化**
   - 事前コンパイル
   - 不要な処理の削減

4. **OpenRestyの設定チューニング**
   - ワーカープロセス数の調整
   - バッファサイズの最適化

### WordPress

1. **URL構造の修正**: ベンチマークスクリプトのURL形式を修正
2. **パーマリンク設定の確認**: WordPress管理画面で設定を確認
3. **FastCGI Cache設定の見直し**: キャッシュキー生成ルールの調整

---

## 結論

**現状の性能比較**:
- WordPress（キャッシュヒット時）: **87,000 req/sec**, レイテンシ **2ms**
- WordPress（実質成功率）: **約10 req/sec**（エラーにより）
- LuaAIDiary（キャッシュなし）: **800 req/sec**, レイテンシ **150ms**
- LuaAIDiary（ヘルスチェック）: **57,500 req/sec**, レイテンシ **3.7ms**

**総合評価**:
- LuaAIDiaryは安定しているが、WordPressと比較して性能が約100倍遅い
- キャッシュ機構の導入が最優先の改善項目
- ヘルスチェックの高性能から、アプリケーションロジックがボトルネックと判明
- WordPressのテスト結果は設定エラーの可能性が高く、再テストが必要

---

## 生成されたファイル一覧

### WordPress結果
- `tests/performance/results/wordpress/benchmark_20251231_150841.log`
- `tests/performance/results/wordpress/scenario1_home_t4_c100_20251231_150841.txt`
- `tests/performance/results/wordpress/scenario1_home_t8_c200_20251231_150841.txt`
- `tests/performance/results/wordpress/scenario1_home_t12_c400_20251231_150841.txt`
- `tests/performance/results/wordpress/scenario2_random_posts_t8_c200_20251231_150841.txt`
- `tests/performance/results/wordpress/summary_20251231_150841.txt`

### LuaAIDiary結果
- `tests/performance/results/luaaidiary/benchmark_20251231_151448.log`
- `tests/performance/results/luaaidiary/scenario1_home_t4_c100_20251231_151448.txt`
- `tests/performance/results/luaaidiary/scenario1_home_t8_c200_20251231_151448.txt`
- `tests/performance/results/luaaidiary/scenario1_home_t12_c400_20251231_151448.txt`
- `tests/performance/results/luaaidiary/scenario2_random_posts_t8_c200_20251231_151448.txt`
- `tests/performance/results/luaaidiary/scenario3_health_t8_c200_20251231_151448.txt`
- `tests/performance/results/luaaidiary/summary_20251231_151448.txt`

---

## 📚 関連ドキュメント

### 詳細分析レポート
包括的な最終レポートを作成しました：
- **[`docs/performance_comparison_report.md`](../../../docs/performance_comparison_report.md)** - 詳細な性能比較分析レポート
  - エグゼクティブサマリー
  - テスト環境の詳細
  - 詳細結果（全シナリオ）
  - 比較分析とボトルネック特定
  - 問題点と制約事項
  - 改善提案
  - 結論

### 改善実装計画
LuaAIDiaryの性能改善のための詳細な実装計画：
- **[`plans/performance_improvement_plan.md`](../../../plans/performance_improvement_plan.md)** - 段階的改善計画
  - 短期改善（1-2週間）：DBインデックス、キャッシュ導入 → 3,000-5,000 req/sec
  - 中期改善（1-2ヶ月）：クエリ最適化、テンプレート最適化 → 15,000-25,000 req/sec
  - 長期改善（3ヶ月以上）：CDN、水平スケーリング → 50,000+ req/sec

---

## 🎯 次のステップ

### 最優先アクション（今週中）
1. ✅ **WordPressの設定確認と再テスト**
   - パーマリンク設定の確認
   - FastCGI Cacheの動作検証
   - 正しいURL形式でのベンチマーク再実行

2. ✅ **LuaAIDiaryへのDBインデックス追加**（0.5日）
   - 即効性があり、リスクが低い
   - 期待効果: 1.5-2倍のスループット向上

3. ✅ **ページキャッシュ機構の実装開始**（5-7日）
   - lua-resty-lrucacheを使用
   - 期待効果: 10-50倍のスループット向上

### 中期目標（1-2ヶ月）
- データベースクエリの最適化
- テンプレートエンジンの最適化
- Redis活用の高度なキャッシュ戦略
- **目標スループット**: 15,000-25,000 req/sec

---

**サマリー作成日**: 2025年12月31日
**最終更新**: 2025年12月31日（詳細レポート・改善計画リンク追加）
