# 統合テスト実装レポート

Week 3で実装した機能（CSRF保護、投稿CRUD API）に対する統合テスト実装の詳細レポート

## 実装サマリー

✅ **実装完了**: モックを使わない統合テストを実装しました

実装したテスト種別：
1. **統合テスト（Integration Tests）**: 実際のPostgreSQLデータベースを使用したモデル層のテスト
2. **E2Eテスト（End-to-End Tests）**: HTTPリクエストを使用したAPI全体のテスト

## 実装内容

### 1. 統合テスト（`tests/integration/`）

#### 実装ファイル

- **[`test_helper_integration.lua`](integration/test_helper_integration.lua)**: 統合テスト用ヘルパー
  - データベース接続管理
  - トランザクション管理
  - テストデータ作成・クリーンアップ
  - アサーション関数

- **[`test_post_model_integration_spec.lua`](integration/test_post_model_integration_spec.lua)**: 投稿モデルの統合テスト
  - 投稿作成（カテゴリー・タグ付き）
  - 投稿取得（スラッグ検索、公開済み投稿）
  - 投稿更新（ステータス変更）
  - カテゴリー・タグ管理
  - トランザクションの動作検証

#### 技術的アプローチ

```lua
-- トランザクションを使用した分離とクリーンアップ
before_each(function()
  db = helper.setup_db()
  helper.begin_transaction(db)  -- トランザクション開始
  -- テストデータ作成
end)

after_each(function()
  helper.rollback_transaction(db)  -- 自動ロールバック
  helper.teardown_db(db)
end)
```

**特徴**：
- ✅ 実際のPostgreSQLに接続
- ✅ pgmoonライブラリを使用
- ✅ トランザクションによるテストの分離
- ✅ 自動的なデータクリーンアップ
- ✅ モックなしで実際のコード実行パスをテスト

### 2. E2Eテスト（`tests/e2e/`）

#### 実装ファイル

- **[`test_post_api.sh`](e2e/test_post_api.sh)**: 投稿API E2Eテストスクリプト
  - 認証フロー（登録、ログイン、ログアウト）
  - 投稿CRUD操作（作成、取得、更新、削除）
  - 認証チェック（401エラーの検証）
  - ヘルスチェック、DB接続確認

#### 技術的アプローチ

```bash
# curlを使用した実際のHTTPリクエスト
response=$(curl -s -w "\n%{http_code}" \
  -X POST "$API_URL/posts" \
  -H "Content-Type: application/json" \
  -b "$COOKIE_FILE" \
  -d '{"title":"Test","content":"Content"}')

http_code=$(echo "$response" | tail -n 1)
body=$(echo "$response" | head -n -1)
```

**特徴**：
- ✅ 実際のHTTPリクエスト（curl使用）
- ✅ セッションCookie管理
- ✅ 全スタック（Web層〜DB層）をテスト
- ✅ カラフルな出力とテスト結果カウント
- ✅ 詳細なエラーレポート

### 3. Makefileタスク

新たに追加したコマンド：

```makefile
make test            # ユニットテスト（モックベース）
make test-integration # 統合テスト（実際のDB使用）
make test-e2e         # E2Eテスト（HTTP経由）
make test-all         # すべてのテストを実行
```

## テスト実行方法

### 前提条件

```bash
# サービスを起動
make up

# または開発モード
make dev
```

### 個別実行

```bash
# 統合テストのみ
make test-integration

# E2Eテストのみ
make test-e2e

# ユニットテストのみ
make test
```

### 全テスト実行

```bash
# すべてのテストを順次実行
make test-all
```

## テスト戦略

### 3層テストアプローチ

```
┌──────────────────────────────────────┐
│  E2Eテスト（HTTP経由）                 │
│  - API全体のテスト                    │
│  - 認証フロー                         │
│  - エンドツーエンドシナリオ            │
└──────────────────────────────────────┘
              ↓
┌──────────────────────────────────────┐
│  ユニットテスト（モックベース）          │
│  - コントローラー層                    │
│  - ビジネスロジック                    │
│  - バリデーション                      │
└──────────────────────────────────────┘
              ↓
┌──────────────────────────────────────┐
│  統合テスト（実際のDB）                │
│  - モデル層                           │
│  - データベース操作                    │
│  - トランザクション                    │
└──────────────────────────────────────┘
```

### カバレッジマトリックス

| テスト種別 | Web層 | コントローラー層 | モデル層 | DB層 | 認証 |
|----------|-------|---------------|---------|------|------|
| E2E | ✅ | ✅ | ✅ | ✅ | ✅ |
| ユニット | - | ✅（モック） | ✅（モック） | - | ✅（モック） |
| 統合 | - | - | ✅（実際） | ✅（実際） | - |

## 実装できた機能

### ✅ 成功した実装

1. **実際のデータベース接続**
   - pgmoonを使用した直接的なPostgreSQL接続
   - トランザクション管理（BEGIN/COMMIT/ROLLBACK）
   - 接続プールの適切な管理

2. **モデル層の統合テスト**
   - 投稿作成・更新・削除の実際の動作確認
   - カテゴリー・タグの関連付けテスト
   - スラッグ生成・ユニーク制約の検証
   - 公開日時の自動設定テスト

3. **E2Eテストによる完全なAPI検証**
   - HTTPリクエスト/レスポンスの検証
   - セッション管理とCookie処理
   - 認証フローの完全なテスト
   - ステータスコードの検証

4. **自動化とクリーンアップ**
   - トランザクションによる自動ロールバック
   - テストデータの識別可能な命名
   - Makefileによる簡単な実行

## 技術的な制約と対処

### 制約1: OpenRestyコンテキストの制限

**問題**: 
- `ngx.*` APIの一部はテスト環境で利用不可
- `ngx.log`, `ngx.quote_sql_str` などが必要

**解決策**:
```lua
-- test_helper内でngxモックを提供
function _M.setup_ngx_mock()
  if not _G.ngx then
    _G.ngx = {
      log = function(level, ...) end,
      quote_sql_str = function(str)
        local escaped = str:gsub("'", "''")
        return "'" .. escaped .. "'"
      end,
      -- その他必要なAPI
    }
  end
end
```

### 制約2: Redisセッション管理のテスト

**問題**:
- 統合テストでRedisセッションを直接テストするのは複雑

**解決策**:
- モデル層の統合テストではセッション管理を除外
- E2EテストでHTTP経由のセッション管理を検証
- 責任分離により各層を効果的にテスト

### 制約3: HTTPコントローラーのテスト

**問題**:
- コントローラー層は`ngx.req`, `ngx.say`などに依存

**解決策**:
- コントローラー: モックベースのユニットテスト（`tests/controllers/`）
- E2E: HTTP経由の完全なテスト（`tests/e2e/`）
- 統合: モデル層に焦点（`tests/integration/`）

## 実装できなかった機能と代替案

### ❌ 完全モックレスのコントローラーテスト

**理由**:
- LapisフレームワークはOpenResty/nginxコンテキストに強く依存
- `ngx.*` APIのモックなしではコントローラーを実行不可

**代替案**:
- ✅ モックベースのユニットテストで論理をテスト
- ✅ E2EテストでHTTP経由の実際の動作を検証
- ✅ 統合テストでモデル層を徹底的にテスト

### ❌ Redisの統合テスト

**理由**:
- セッション管理はHTTPコンテキストと密接に関連
- 直接的なRedis統合テストは複雑

**代替案**:
- ✅ E2EテストでセッションCookieを使用して実際の動作を検証
- ✅ 認証フロー全体をHTTP経由でテスト

## ベストプラクティス

実装で採用したベストプラクティス：

1. **テストの分離**: トランザクションを使用して各テストを完全に分離
2. **明確な命名**: テストデータに`TEST_`/`test_`プレフィックスを使用
3. **自動クリーンアップ**: ロールバックによる確実なデータ削除
4. **包括的なドキュメント**: 各ディレクトリにREADME.mdを配置
5. **段階的アプローチ**: ユニット→統合→E2Eの3層戦略

## パフォーマンスと実行時間

### 推定実行時間

- ユニットテスト: ~5秒（モックベース、高速）
- 統合テスト: ~10-15秒（実際のDB接続、トランザクション）
- E2Eテスト: ~20-30秒（HTTP、認証フロー、複数リクエスト）
- **全テスト**: ~35-50秒

### 最適化のポイント

- トランザクションの使用により、統合テストは高速
- 並列実行は避ける（データベースの競合を防ぐ）
- E2Eテストはシーケンシャルに実行

## 今後の拡張

### 優先度: 高

- [ ] カテゴリーモデルの統合テスト
- [ ] タグモデルの統合テスト
- [ ] ユーザーモデルの統合テスト
- [ ] カテゴリーAPIのE2Eテスト
- [ ] タグAPIのE2Eテスト

### 優先度: 中

- [ ] コメント機能の統合テスト
- [ ] ファイルアップロードのE2Eテスト
- [ ] パフォーマンステスト（応答時間測定）
- [ ] エラーハンドリングの詳細テスト

### 優先度: 低

- [ ] 負荷テスト
- [ ] セキュリティテスト（SQLインジェクション、XSS）
- [ ] CI/CDパイプラインへの統合

## 結論

### 達成したこと

✅ **主要目標を達成**: モックを使わない統合テストを実装
- 実際のPostgreSQLデータベースを使用
- 実際のHTTPリクエストによるE2Eテスト
- 自動化されたテストスイート
- 包括的なドキュメント

### 技術的アプローチの妥当性

3層テスト戦略により、以下を実現：

1. **モデル層**: 統合テストで実際のDBを使用して徹底的にテスト
2. **コントローラー層**: モックベースのユニットテストで論理を検証
3. **エンドツーエンド**: E2EテストでHTTP経由の実際の動作を確認

この組み合わせにより、**モックを使わない部分（モデル層とE2E）と使う部分（コントローラー）を適切に分離**し、効果的なテストカバレッジを実現しました。

### 推奨事項

1. **継続的な実行**: CI/CDパイプラインに統合テストとE2Eテストを組み込む
2. **定期的なクリーンアップ**: テストユーザーデータの定期削除
3. **テストの拡張**: 新機能追加時に対応する統合テスト・E2Eテストも追加
4. **ドキュメントの更新**: テストが追加されたらREADMEも更新

## 参考資料

- [統合テストREADME](integration/README.md)
- [E2EテストREADME](e2e/README.md)
- [Busted Testing Framework](https://olivinelabs.com/busted/)
- [pgmoon Documentation](https://github.com/leafo/pgmoon)
- [Lapis Framework](https://leafo.net/lapis/)

---

**実装者**: Claude (AI Assistant)  
**実装日**: 2025-12-26  
**プロジェクト**: LuaAIDiary Week 3 統合テスト
