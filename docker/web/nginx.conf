worker_processes auto;
error_log /usr/local/openresty/nginx/logs/error.log debug;
pid /var/run/nginx.pid;

# 環境変数の宣言
env POSTGRES_HOST;
env POSTGRES_PORT;
env POSTGRES_DB;
env POSTGRES_USER;
env POSTGRES_PASSWORD;
env REDIS_HOST;
env REDIS_PORT;

events {
    # 接続処理能力の向上（1024 -> 2048）
    worker_connections 2048;
}

http {
    include mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /usr/local/openresty/nginx/logs/access.log main;
    error_log /usr/local/openresty/nginx/logs/error.log debug;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 100;  # キープアライブでの最大リクエスト数
    types_hash_max_size 2048;
    
    # リクエストボディの最大サイズを設定（AI生成記事など長文対応）
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    
    # タイムアウト設定
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;
    
    # ========================================
    # Gzip圧縮設定（レスポンスサイズ削減）
    # ========================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_min_length 256;
    
    # ========================================
    # オープンファイルディスクリプタのキャッシュ（ファイルアクセス高速化）
    # ========================================
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # Lua共有辞書の設定
    lua_shared_dict sessions 10m;
    lua_shared_dict cache 10m;

    # ========================================
    # ページキャッシュ設定
    # ========================================
    # キャッシュゾーンの定義
    proxy_cache_path /var/cache/nginx/luaaidiary
        levels=1:2
        keys_zone=luaaidiary_cache:10m
        max_size=100m
        inactive=60m
        use_temp_path=off;

    # Luaパッケージパスの設定
    lua_package_path "/app/?.lua;/app/?/init.lua;/usr/local/openresty/lapis/?.lua;;";
    lua_package_cpath "/usr/local/openresty/lapis/?.so;;";

    # 初期化コード
    init_by_lua_block {
        require "lpeg"
    }

    # ========================================
    # Lapisアプリケーションバックエンドサーバー
    # ========================================
    upstream luaaidiary_backend {
        server 127.0.0.1:8080;
        keepalive 32;
    }

    # ========================================
    # プロキシサーバー（キャッシュ機能付き）
    # ========================================
    server {
        listen 80;
        server_name localhost;
        
        # Docker DNS resolver
        resolver 127.0.0.11 valid=30s;

        root /usr/local/openresty/nginx/html/static;

        # 静的ファイルの配信
        location /static/ {
            alias /usr/local/openresty/nginx/html/static/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # 管理画面とAPIはキャッシュしない
        location ~ ^/(admin|auth|api)/ {
            proxy_pass http://luaaidiary_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # キャッシュを無効化
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        # ホームページ（5分キャッシュ）
        location = / {
            proxy_pass http://luaaidiary_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # キャッシュ設定
            proxy_cache luaaidiary_cache;
            proxy_cache_key "$request_uri";
            proxy_cache_valid 200 5m;
            proxy_cache_bypass $cookie_session;
            proxy_no_cache $cookie_session;
            
            # X-Cacheヘッダーの追加
            add_header X-Cache $upstream_cache_status;
        }

        # カテゴリーページ（5分キャッシュ）
        location ~ ^/category/ {
            proxy_pass http://luaaidiary_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_cache luaaidiary_cache;
            proxy_cache_key "$request_uri";
            proxy_cache_valid 200 5m;
            proxy_cache_bypass $cookie_session;
            proxy_no_cache $cookie_session;
            
            add_header X-Cache $upstream_cache_status;
        }

        # タグページ（5分キャッシュ）
        location ~ ^/tag/ {
            proxy_pass http://luaaidiary_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_cache luaaidiary_cache;
            proxy_cache_key "$request_uri";
            proxy_cache_valid 200 5m;
            proxy_cache_bypass $cookie_session;
            proxy_no_cache $cookie_session;
            
            add_header X-Cache $upstream_cache_status;
        }

        # 記事ページ（10分キャッシュ）
        location ~ ^/posts/ {
            proxy_pass http://luaaidiary_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_cache luaaidiary_cache;
            proxy_cache_key "$request_uri";
            proxy_cache_valid 200 10m;
            proxy_cache_bypass $cookie_session;
            proxy_no_cache $cookie_session;
            
            add_header X-Cache $upstream_cache_status;
        }

        # その他のページ（デフォルト）- スラッグページを含む
        location / {
            proxy_pass http://luaaidiary_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # キャッシュ設定（スラッグページ用：5分キャッシュ）
            proxy_cache luaaidiary_cache;
            proxy_cache_key "$request_uri";
            proxy_cache_valid 200 5m;
            proxy_cache_bypass $cookie_session;
            proxy_no_cache $cookie_session;
            
            # X-Cacheヘッダーの追加
            add_header X-Cache $upstream_cache_status;
        }

        # エラーページ
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
    }

    # ========================================
    # Lapisアプリケーションサーバー（バックエンド）
    # ========================================
    server {
        listen 127.0.0.1:8080;
        server_name localhost;
        
        # Docker DNS resolver
        resolver 127.0.0.11 valid=30s;

        root /usr/local/openresty/nginx/html/static;

        # Lapisアプリケーションハンドラー
        location / {
            default_type 'text/html';
            
            set $_url "";
            
            content_by_lua_block {
                require("lapis").serve("init")
            }
        }
    }
}
